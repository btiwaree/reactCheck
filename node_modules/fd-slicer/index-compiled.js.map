{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["var fs = require('fs');\nvar util = require('util');\nvar stream = require('stream');\nvar Readable = stream.Readable;\nvar Writable = stream.Writable;\nvar PassThrough = stream.PassThrough;\nvar Pend = require('pend');\nvar EventEmitter = require('events').EventEmitter;\n\nexports.createFromBuffer = createFromBuffer;\nexports.createFromFd = createFromFd;\nexports.BufferSlicer = BufferSlicer;\nexports.FdSlicer = FdSlicer;\n\nutil.inherits(FdSlicer, EventEmitter);\nfunction FdSlicer(fd, options) {\n  options = options || {};\n  EventEmitter.call(this);\n\n  this.fd = fd;\n  this.pend = new Pend();\n  this.pend.max = 1;\n  this.refCount = 0;\n  this.autoClose = !!options.autoClose;\n}\n\nFdSlicer.prototype.read = function(buffer, offset, length, position, callback) {\n  var self = this;\n  self.pend.go(function(cb) {\n    fs.read(self.fd, buffer, offset, length, position, function(err, bytesRead, buffer) {\n      cb();\n      callback(err, bytesRead, buffer);\n    });\n  });\n};\n\nFdSlicer.prototype.write = function(buffer, offset, length, position, callback) {\n  var self = this;\n  self.pend.go(function(cb) {\n    fs.write(self.fd, buffer, offset, length, position, function(err, written, buffer) {\n      cb();\n      callback(err, written, buffer);\n    });\n  });\n};\n\nFdSlicer.prototype.createReadStream = function(options) {\n  return new ReadStream(this, options);\n};\n\nFdSlicer.prototype.createWriteStream = function(options) {\n  return new WriteStream(this, options);\n};\n\nFdSlicer.prototype.ref = function() {\n  this.refCount += 1;\n};\n\nFdSlicer.prototype.unref = function() {\n  var self = this;\n  self.refCount -= 1;\n\n  if (self.refCount > 0) return;\n  if (self.refCount < 0) throw new Error(\"invalid unref\");\n\n  if (self.autoClose) {\n    fs.close(self.fd, onCloseDone);\n  }\n\n  function onCloseDone(err) {\n    if (err) {\n      self.emit('error', err);\n    } else {\n      self.emit('close');\n    }\n  }\n};\n\nutil.inherits(ReadStream, Readable);\nfunction ReadStream(context, options) {\n  options = options || {};\n  Readable.call(this, options);\n\n  this.context = context;\n  this.context.ref();\n\n  this.start = options.start || 0;\n  this.endOffset = options.end;\n  this.pos = this.start;\n  this.destroyed = false;\n}\n\nReadStream.prototype._read = function(n) {\n  var self = this;\n  if (self.destroyed) return;\n\n  var toRead = Math.min(self._readableState.highWaterMark, n);\n  if (self.endOffset != null) {\n    toRead = Math.min(toRead, self.endOffset - self.pos);\n  }\n  if (toRead <= 0) {\n    self.destroyed = true;\n    self.push(null);\n    self.context.unref();\n    return;\n  }\n  self.context.pend.go(function(cb) {\n    if (self.destroyed) return cb();\n    var buffer = new Buffer(toRead);\n    fs.read(self.context.fd, buffer, 0, toRead, self.pos, function(err, bytesRead) {\n      if (err) {\n        self.destroy(err);\n      } else if (bytesRead === 0) {\n        self.destroyed = true;\n        self.push(null);\n        self.context.unref();\n      } else {\n        self.pos += bytesRead;\n        self.push(buffer.slice(0, bytesRead));\n      }\n      cb();\n    });\n  });\n};\n\nReadStream.prototype.destroy = function(err) {\n  if (this.destroyed) return;\n  err = err || new Error(\"stream destroyed\");\n  this.destroyed = true;\n  this.emit('error', err);\n  this.context.unref();\n};\n\nutil.inherits(WriteStream, Writable);\nfunction WriteStream(context, options) {\n  options = options || {};\n  Writable.call(this, options);\n\n  this.context = context;\n  this.context.ref();\n\n  this.start = options.start || 0;\n  this.endOffset = (options.end == null) ? Infinity : +options.end;\n  this.bytesWritten = 0;\n  this.pos = this.start;\n  this.destroyed = false;\n\n  this.on('finish', this.destroy.bind(this));\n}\n\nWriteStream.prototype._write = function(buffer, encoding, callback) {\n  var self = this;\n  if (self.destroyed) return;\n\n  if (self.pos + buffer.length > self.endOffset) {\n    var err = new Error(\"maximum file length exceeded\");\n    err.code = 'ETOOBIG';\n    self.destroy();\n    callback(err);\n    return;\n  }\n  self.context.pend.go(function(cb) {\n    if (self.destroyed) return cb();\n    fs.write(self.context.fd, buffer, 0, buffer.length, self.pos, function(err, bytes) {\n      if (err) {\n        self.destroy();\n        cb();\n        callback(err);\n      } else {\n        self.bytesWritten += bytes;\n        self.pos += bytes;\n        self.emit('progress');\n        cb();\n        callback();\n      }\n    });\n  });\n};\n\nWriteStream.prototype.destroy = function() {\n  if (this.destroyed) return;\n  this.destroyed = true;\n  this.context.unref();\n};\n\nutil.inherits(BufferSlicer, EventEmitter);\nfunction BufferSlicer(buffer) {\n  EventEmitter.call(this);\n\n  this.refCount = 0;\n  this.buffer = buffer;\n}\n\nBufferSlicer.prototype.read = function(buffer, offset, length, position, callback) {\n  var end = position + length;\n  var delta = end - this.buffer.length;\n  var written = (delta > 0) ? delta : length;\n  this.buffer.copy(buffer, offset, position, end);\n  setImmediate(function() {\n    callback(null, written);\n  });\n};\n\nBufferSlicer.prototype.write = function(buffer, offset, length, position, callback) {\n  buffer.copy(this.buffer, position, offset, offset + length);\n  setImmediate(function() {\n    callback(null, length, buffer);\n  });\n};\n\nBufferSlicer.prototype.createReadStream = function(options) {\n  options = options || {};\n  var readStream = new PassThrough(options);\n  readStream.start = options.start || 0;\n  readStream.endOffset = options.end;\n  readStream.pos = readStream.endOffset || this.buffer.length; // yep, we're already done\n  readStream.destroyed = false;\n  readStream.write(this.buffer.slice(readStream.start, readStream.pos));\n  readStream.end();\n  readStream.destroy = function() {\n    readStream.destroyed = true;\n  };\n  return readStream;\n};\n\nBufferSlicer.prototype.createWriteStream = function(options) {\n  var bufferSlicer = this;\n  options = options || {};\n  var writeStream = new Writable(options);\n  writeStream.start = options.start || 0;\n  writeStream.endOffset = (options.end == null) ? this.buffer.length : +options.end;\n  writeStream.bytesWritten = 0;\n  writeStream.pos = writeStream.start;\n  writeStream.destroyed = false;\n  writeStream._write = function(buffer, encoding, callback) {\n    if (writeStream.destroyed) return;\n\n    var end = writeStream.pos + buffer.length;\n    if (end > writeStream.endOffset) {\n      var err = new Error(\"maximum file length exceeded\");\n      err.code = 'ETOOBIG';\n      writeStream.destroyed = true;\n      callback(err);\n      return;\n    }\n    buffer.copy(bufferSlicer.buffer, writeStream.pos, 0, buffer.length);\n\n    writeStream.bytesWritten += buffer.length;\n    writeStream.pos = end;\n    writeStream.emit('progress');\n    callback();\n  };\n  writeStream.destroy = function() {\n    writeStream.destroyed = true;\n  };\n  return writeStream;\n};\n\nBufferSlicer.prototype.ref = function() {\n  this.refCount += 1;\n};\n\nBufferSlicer.prototype.unref = function() {\n  this.refCount -= 1;\n\n  if (this.refCount < 0) {\n    throw new Error(\"invalid unref\");\n  }\n};\n\nfunction createFromBuffer(buffer) {\n  return new BufferSlicer(buffer);\n}\n\nfunction createFromFd(fd, options) {\n  return new FdSlicer(fd, options);\n}\n"]}