{"version":3,"sources":["6-restructBlock.js"],"names":[],"mappings":"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","file":"6-restructBlock-compiled.js","sourcesContent":["var resolveProperty = require('../ast/names.js').property;\nvar resolveKeyword = require('../ast/names.js').keyword;\nvar internalWalkRulesRight = require('../ast/walk.js').rulesRight;\nvar translate = require('../ast/translate.js');\nvar dontRestructure = {\n    'src': 1 // https://github.com/afelix/csso/issues/50\n};\n\nvar DONT_MIX_VALUE = {\n    // https://developer.mozilla.org/en-US/docs/Web/CSS/display#Browser_compatibility\n    'display': /table|ruby|flex|-(flex)?box$|grid|contents|run-in/i,\n    // https://developer.mozilla.org/en/docs/Web/CSS/text-align\n    'text-align': /^(start|end|match-parent|justify-all)$/i\n};\n\nvar NEEDLESS_TABLE = {\n    'border-width': ['border'],\n    'border-style': ['border'],\n    'border-color': ['border'],\n    'border-top': ['border'],\n    'border-right': ['border'],\n    'border-bottom': ['border'],\n    'border-left': ['border'],\n    'border-top-width': ['border-top', 'border-width', 'border'],\n    'border-right-width': ['border-right', 'border-width', 'border'],\n    'border-bottom-width': ['border-bottom', 'border-width', 'border'],\n    'border-left-width': ['border-left', 'border-width', 'border'],\n    'border-top-style': ['border-top', 'border-style', 'border'],\n    'border-right-style': ['border-right', 'border-style', 'border'],\n    'border-bottom-style': ['border-bottom', 'border-style', 'border'],\n    'border-left-style': ['border-left', 'border-style', 'border'],\n    'border-top-color': ['border-top', 'border-color', 'border'],\n    'border-right-color': ['border-right', 'border-color', 'border'],\n    'border-bottom-color': ['border-bottom', 'border-color', 'border'],\n    'border-left-color': ['border-left', 'border-color', 'border'],\n    'margin-top': ['margin'],\n    'margin-right': ['margin'],\n    'margin-bottom': ['margin'],\n    'margin-left': ['margin'],\n    'padding-top': ['padding'],\n    'padding-right': ['padding'],\n    'padding-bottom': ['padding'],\n    'padding-left': ['padding'],\n    'font-style': ['font'],\n    'font-variant': ['font'],\n    'font-weight': ['font'],\n    'font-size': ['font'],\n    'font-family': ['font'],\n    'list-style-type': ['list-style'],\n    'list-style-position': ['list-style'],\n    'list-style-image': ['list-style']\n};\n\nfunction getPropertyFingerprint(propertyName, declaration, fingerprints) {\n    var realName = resolveProperty(propertyName).name;\n\n    if (realName === 'background' ||\n       (realName === 'filter' && declaration.value.sequence.first().type === 'Progid')) {\n        return propertyName + ':' + translate(declaration.value);\n    }\n\n    var declarationId = declaration.id;\n    var fingerprint = fingerprints[declarationId];\n\n    if (!fingerprint) {\n        var vendorId = '';\n        var hack9 = '';\n        var special = {};\n\n        declaration.value.sequence.each(function walk(node) {\n            switch (node.type) {\n                case 'Argument':\n                case 'Value':\n                case 'Braces':\n                    node.sequence.each(walk);\n                    break;\n\n                case 'Identifier':\n                    var name = node.name;\n\n                    if (!vendorId) {\n                        vendorId = resolveKeyword(name).vendor;\n                    }\n\n                    if (name === '\\\\9') {\n                        hack9 = name;\n                    }\n\n                    if (DONT_MIX_VALUE.hasOwnProperty(realName) &&\n                        DONT_MIX_VALUE[realName].test(name)) {\n                        special[name] = true;\n                    }\n\n                    break;\n\n                case 'Function':\n                    var name = node.name;\n\n                    if (!vendorId) {\n                        vendorId = resolveKeyword(name).vendor;\n                    }\n\n                    if (name === 'rect') {\n                        // there are 2 forms of rect:\n                        //   rect(<top>, <right>, <bottom>, <left>) - standart\n                        //   rect(<top> <right> <bottom> <left>) – backwards compatible syntax\n                        // only the same form values can be merged\n                        if (node.arguments.size < 4) {\n                            name = 'rect-backward';\n                        }\n                    }\n\n                    special[name + '()'] = true;\n\n                    // check nested tokens too\n                    node.arguments.each(walk);\n\n                    break;\n\n                case 'Dimension':\n                    var unit = node.unit;\n\n                    switch (unit) {\n                        // is not supported until IE11\n                        case 'rem':\n\n                        // v* units is too buggy across browsers and better\n                        // don't merge values with those units\n                        case 'vw':\n                        case 'vh':\n                        case 'vmin':\n                        case 'vmax':\n                        case 'vm': // IE9 supporting \"vm\" instead of \"vmin\".\n                            special[unit] = true;\n                            break;\n                    }\n                    break;\n            }\n        });\n\n        fingerprint = '|' + Object.keys(special).sort() + '|' + hack9 + vendorId;\n\n        fingerprints[declarationId] = fingerprint;\n    }\n\n    return propertyName + fingerprint;\n}\n\nfunction needless(props, declaration, fingerprints) {\n    var property = resolveProperty(declaration.property.name);\n\n    if (NEEDLESS_TABLE.hasOwnProperty(property.name)) {\n        var table = NEEDLESS_TABLE[property.name];\n\n        for (var i = 0; i < table.length; i++) {\n            var ppre = getPropertyFingerprint(property.prefix + table[i], declaration, fingerprints);\n            var prev = props[ppre];\n\n            if (prev && (!declaration.value.important || prev.item.data.value.important)) {\n                return prev;\n            }\n        }\n    }\n}\n\nfunction processRuleset(ruleset, item, list, props, fingerprints) {\n    var declarations = ruleset.block.declarations;\n\n    declarations.eachRight(function(declaration, declarationItem) {\n        var property = declaration.property.name;\n        var fingerprint = getPropertyFingerprint(property, declaration, fingerprints);\n        var prev = props[fingerprint];\n\n        if (prev && !dontRestructure.hasOwnProperty(property)) {\n            if (declaration.value.important && !prev.item.data.value.important) {\n                props[fingerprint] = {\n                    block: declarations,\n                    item: declarationItem\n                };\n\n                prev.block.remove(prev.item);\n                declaration.info = {\n                    primary: declaration.info,\n                    merged: prev.item.data.info\n                };\n            } else {\n                declarations.remove(declarationItem);\n                prev.item.data.info = {\n                    primary: prev.item.data.info,\n                    merged: declaration.info\n                };\n            }\n        } else {\n            var prev = needless(props, declaration, fingerprints);\n\n            if (prev) {\n                declarations.remove(declarationItem);\n                prev.item.data.info = {\n                    primary: prev.item.data.info,\n                    merged: declaration.info\n                };\n            } else {\n                declaration.fingerprint = fingerprint;\n\n                props[fingerprint] = {\n                    block: declarations,\n                    item: declarationItem\n                };\n            }\n        }\n    });\n\n    if (declarations.isEmpty()) {\n        list.remove(item);\n    }\n};\n\nmodule.exports = function restructBlock(ast) {\n    var stylesheetMap = {};\n    var fingerprints = Object.create(null);\n\n    internalWalkRulesRight(ast, function(node, item, list) {\n        if (node.type !== 'Ruleset') {\n            return;\n        }\n\n        var stylesheet = this.stylesheet;\n        var rulesetId = (node.pseudoSignature || '') + '|' + node.selector.selectors.first().id;\n        var rulesetMap;\n        var props;\n\n        if (!stylesheetMap.hasOwnProperty(stylesheet.id)) {\n            rulesetMap = {};\n            stylesheetMap[stylesheet.id] = rulesetMap;\n        } else {\n            rulesetMap = stylesheetMap[stylesheet.id];\n        }\n\n        if (rulesetMap.hasOwnProperty(rulesetId)) {\n            props = rulesetMap[rulesetId];\n        } else {\n            props = {};\n            rulesetMap[rulesetId] = props;\n        }\n\n        processRuleset.call(this, node, item, list, props, fingerprints);\n    });\n};\n"]}