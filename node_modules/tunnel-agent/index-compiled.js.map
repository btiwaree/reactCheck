{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["'use strict'\n\nvar net = require('net')\n  , tls = require('tls')\n  , http = require('http')\n  , https = require('https')\n  , events = require('events')\n  , assert = require('assert')\n  , util = require('util')\n  ;\n\nexports.httpOverHttp = httpOverHttp\nexports.httpsOverHttp = httpsOverHttp\nexports.httpOverHttps = httpOverHttps\nexports.httpsOverHttps = httpsOverHttps\n\n\nfunction httpOverHttp(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = http.request\n  return agent\n}\n\nfunction httpsOverHttp(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = http.request\n  agent.createSocket = createSecureSocket\n  agent.defaultPort = 443\n  return agent\n}\n\nfunction httpOverHttps(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = https.request\n  return agent\n}\n\nfunction httpsOverHttps(options) {\n  var agent = new TunnelingAgent(options)\n  agent.request = https.request\n  agent.createSocket = createSecureSocket\n  agent.defaultPort = 443\n  return agent\n}\n\n\nfunction TunnelingAgent(options) {\n  var self = this\n  self.options = options || {}\n  self.proxyOptions = self.options.proxy || {}\n  self.maxSockets = self.options.maxSockets || http.Agent.defaultMaxSockets\n  self.requests = []\n  self.sockets = []\n\n  self.on('free', function onFree(socket, host, port) {\n    for (var i = 0, len = self.requests.length; i < len; ++i) {\n      var pending = self.requests[i]\n      if (pending.host === host && pending.port === port) {\n        // Detect the request to connect same origin server,\n        // reuse the connection.\n        self.requests.splice(i, 1)\n        pending.request.onSocket(socket)\n        return\n      }\n    }\n    socket.destroy()\n    self.removeSocket(socket)\n  })\n}\nutil.inherits(TunnelingAgent, events.EventEmitter)\n\nTunnelingAgent.prototype.addRequest = function addRequest(req, options) {\n  var self = this\n\n   // Legacy API: addRequest(req, host, port, path)\n  if (typeof options === 'string') {\n    options = {\n      host: options,\n      port: arguments[2],\n      path: arguments[3]\n    };\n  }\n\n  if (self.sockets.length >= this.maxSockets) {\n    // We are over limit so we'll add it to the queue.\n    self.requests.push({host: options.host, port: options.port, request: req})\n    return\n  }\n\n  // If we are under maxSockets create a new one.\n  self.createConnection({host: options.host, port: options.port, request: req})\n}\n\nTunnelingAgent.prototype.createConnection = function createConnection(pending) {\n  var self = this\n\n  self.createSocket(pending, function(socket) {\n    socket.on('free', onFree)\n    socket.on('close', onCloseOrRemove)\n    socket.on('agentRemove', onCloseOrRemove)\n    pending.request.onSocket(socket)\n\n    function onFree() {\n      self.emit('free', socket, pending.host, pending.port)\n    }\n\n    function onCloseOrRemove(err) {\n      self.removeSocket(socket)\n      socket.removeListener('free', onFree)\n      socket.removeListener('close', onCloseOrRemove)\n      socket.removeListener('agentRemove', onCloseOrRemove)\n    }\n  })\n}\n\nTunnelingAgent.prototype.createSocket = function createSocket(options, cb) {\n  var self = this\n  var placeholder = {}\n  self.sockets.push(placeholder)\n\n  var connectOptions = mergeOptions({}, self.proxyOptions, \n    { method: 'CONNECT'\n    , path: options.host + ':' + options.port\n    , agent: false\n    }\n  )\n  if (connectOptions.proxyAuth) {\n    connectOptions.headers = connectOptions.headers || {}\n    connectOptions.headers['Proxy-Authorization'] = 'Basic ' +\n        new Buffer(connectOptions.proxyAuth).toString('base64')\n  }\n\n  debug('making CONNECT request')\n  var connectReq = self.request(connectOptions)\n  connectReq.useChunkedEncodingByDefault = false // for v0.6\n  connectReq.once('response', onResponse) // for v0.6\n  connectReq.once('upgrade', onUpgrade)   // for v0.6\n  connectReq.once('connect', onConnect)   // for v0.7 or later\n  connectReq.once('error', onError)\n  connectReq.end()\n\n  function onResponse(res) {\n    // Very hacky. This is necessary to avoid http-parser leaks.\n    res.upgrade = true\n  }\n\n  function onUpgrade(res, socket, head) {\n    // Hacky.\n    process.nextTick(function() {\n      onConnect(res, socket, head)\n    })\n  }\n\n  function onConnect(res, socket, head) {\n    connectReq.removeAllListeners()\n    socket.removeAllListeners()\n\n    if (res.statusCode === 200) {\n      assert.equal(head.length, 0)\n      debug('tunneling connection has established')\n      self.sockets[self.sockets.indexOf(placeholder)] = socket\n      cb(socket)\n    } else {\n      debug('tunneling socket could not be established, statusCode=%d', res.statusCode)\n      var error = new Error('tunneling socket could not be established, ' + 'statusCode=' + res.statusCode)\n      error.code = 'ECONNRESET'\n      options.request.emit('error', error)\n      self.removeSocket(placeholder)\n    }\n  }\n\n  function onError(cause) {\n    connectReq.removeAllListeners()\n\n    debug('tunneling socket could not be established, cause=%s\\n', cause.message, cause.stack)\n    var error = new Error('tunneling socket could not be established, ' + 'cause=' + cause.message)\n    error.code = 'ECONNRESET'\n    options.request.emit('error', error)\n    self.removeSocket(placeholder)\n  }\n}\n\nTunnelingAgent.prototype.removeSocket = function removeSocket(socket) {\n  var pos = this.sockets.indexOf(socket)\n  if (pos === -1) return\n  \n  this.sockets.splice(pos, 1)\n\n  var pending = this.requests.shift()\n  if (pending) {\n    // If we have pending requests and a socket gets closed a new one\n    // needs to be created to take over in the pool for the one that closed.\n    this.createConnection(pending)\n  }\n}\n\nfunction createSecureSocket(options, cb) {\n  var self = this\n  TunnelingAgent.prototype.createSocket.call(self, options, function(socket) {\n    // 0 is dummy port for v0.6\n    var secureSocket = tls.connect(0, mergeOptions({}, self.options, \n      { servername: options.host\n      , socket: socket\n      }\n    ))\n    self.sockets[self.sockets.indexOf(socket)] = secureSocket\n    cb(secureSocket)\n  })\n}\n\n\nfunction mergeOptions(target) {\n  for (var i = 1, len = arguments.length; i < len; ++i) {\n    var overrides = arguments[i]\n    if (typeof overrides === 'object') {\n      var keys = Object.keys(overrides)\n      for (var j = 0, keyLen = keys.length; j < keyLen; ++j) {\n        var k = keys[j]\n        if (overrides[k] !== undefined) {\n          target[k] = overrides[k]\n        }\n      }\n    }\n  }\n  return target\n}\n\n\nvar debug\nif (process.env.NODE_DEBUG && /\\btunnel\\b/.test(process.env.NODE_DEBUG)) {\n  debug = function() {\n    var args = Array.prototype.slice.call(arguments)\n    if (typeof args[0] === 'string') {\n      args[0] = 'TUNNEL: ' + args[0]\n    } else {\n      args.unshift('TUNNEL:')\n    }\n    console.error.apply(console, args)\n  }\n} else {\n  debug = function() {}\n}\nexports.debug = debug // for test\n"]}