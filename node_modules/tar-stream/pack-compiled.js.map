{"version":3,"sources":["pack.js"],"names":[],"mappings":"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","file":"pack-compiled.js","sourcesContent":["var constants = require('constants')\nvar eos = require('end-of-stream')\nvar util = require('util')\n\nvar Readable = require('readable-stream').Readable\nvar Writable = require('readable-stream').Writable\nvar StringDecoder = require('string_decoder').StringDecoder\n\nvar headers = require('./headers')\n\nvar DMODE = parseInt('755', 8)\nvar FMODE = parseInt('644', 8)\n\nvar END_OF_TAR = new Buffer(1024)\nEND_OF_TAR.fill(0)\n\nvar noop = function () {}\n\nvar overflow = function (self, size) {\n  size &= 511\n  if (size) self.push(END_OF_TAR.slice(0, 512 - size))\n}\n\nfunction modeToType (mode) {\n  switch (mode & constants.S_IFMT) {\n    case constants.S_IFBLK: return 'block-device'\n    case constants.S_IFCHR: return 'character-device'\n    case constants.S_IFDIR: return 'directory'\n    case constants.S_IFIFO: return 'fifo'\n    case constants.S_IFLNK: return 'symlink'\n  }\n\n  return 'file'\n}\n\nvar Sink = function (to) {\n  Writable.call(this)\n  this.written = 0\n  this._to = to\n  this._destroyed = false\n}\n\nutil.inherits(Sink, Writable)\n\nSink.prototype._write = function (data, enc, cb) {\n  this.written += data.length\n  if (this._to.push(data)) return cb()\n  this._to._drain = cb\n}\n\nSink.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar LinkSink = function () {\n  Writable.call(this)\n  this.linkname = ''\n  this._decoder = new StringDecoder('utf-8')\n  this._destroyed = false\n}\n\nutil.inherits(LinkSink, Writable)\n\nLinkSink.prototype._write = function (data, enc, cb) {\n  this.linkname += this._decoder.write(data)\n  cb()\n}\n\nLinkSink.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar Void = function () {\n  Writable.call(this)\n  this._destroyed = false\n}\n\nutil.inherits(Void, Writable)\n\nVoid.prototype._write = function (data, enc, cb) {\n  cb(new Error('No body allowed for this entry'))\n}\n\nVoid.prototype.destroy = function () {\n  if (this._destroyed) return\n  this._destroyed = true\n  this.emit('close')\n}\n\nvar Pack = function (opts) {\n  if (!(this instanceof Pack)) return new Pack(opts)\n  Readable.call(this, opts)\n\n  this._drain = noop\n  this._finalized = false\n  this._finalizing = false\n  this._destroyed = false\n  this._stream = null\n}\n\nutil.inherits(Pack, Readable)\n\nPack.prototype.entry = function (header, buffer, callback) {\n  if (this._stream) throw new Error('already piping an entry')\n  if (this._finalized || this._destroyed) return\n\n  if (typeof buffer === 'function') {\n    callback = buffer\n    buffer = null\n  }\n\n  if (!callback) callback = noop\n\n  var self = this\n\n  if (!header.size || header.type === 'symlink') header.size = 0\n  if (!header.type) header.type = modeToType(header.mode)\n  if (!header.mode) header.mode = header.type === 'directory' ? DMODE : FMODE\n  if (!header.uid) header.uid = 0\n  if (!header.gid) header.gid = 0\n  if (!header.mtime) header.mtime = new Date()\n\n  if (typeof buffer === 'string') buffer = new Buffer(buffer)\n  if (Buffer.isBuffer(buffer)) {\n    header.size = buffer.length\n    this._encode(header)\n    this.push(buffer)\n    overflow(self, header.size)\n    process.nextTick(callback)\n    return new Void()\n  }\n\n  if (header.type === 'symlink' && !header.linkname) {\n    var linkSink = new LinkSink()\n    eos(linkSink, function (err) {\n      if (err) { // stream was closed\n        self.destroy()\n        return callback(err)\n      }\n\n      header.linkname = linkSink.linkname\n      self._encode(header)\n      callback()\n    })\n\n    return linkSink\n  }\n\n  this._encode(header)\n\n  if (header.type !== 'file' && header.type !== 'contiguous-file') {\n    process.nextTick(callback)\n    return new Void()\n  }\n\n  var sink = new Sink(this)\n\n  this._stream = sink\n\n  eos(sink, function (err) {\n    self._stream = null\n\n    if (err) { // stream was closed\n      self.destroy()\n      return callback(err)\n    }\n\n    if (sink.written !== header.size) { // corrupting tar\n      self.destroy()\n      return callback(new Error('size mismatch'))\n    }\n\n    overflow(self, header.size)\n    if (self._finalizing) self.finalize()\n    callback()\n  })\n\n  return sink\n}\n\nPack.prototype.finalize = function () {\n  if (this._stream) {\n    this._finalizing = true\n    return\n  }\n\n  if (this._finalized) return\n  this._finalized = true\n  this.push(END_OF_TAR)\n  this.push(null)\n}\n\nPack.prototype.destroy = function (err) {\n  if (this._destroyed) return\n  this._destroyed = true\n\n  if (err) this.emit('error', err)\n  this.emit('close')\n  if (this._stream && this._stream.destroy) this._stream.destroy()\n}\n\nPack.prototype._encode = function (header) {\n  if (!header.pax) {\n    var buf = headers.encode(header)\n    if (buf) {\n      this.push(buf)\n      return\n    }\n  }\n  this._encodePax(header)\n}\n\nPack.prototype._encodePax = function (header) {\n  var paxHeader = headers.encodePax({\n    name: header.name,\n    linkname: header.linkname,\n    pax: header.pax\n  })\n\n  var newHeader = {\n    name: 'PaxHeader',\n    mode: header.mode,\n    uid: header.uid,\n    gid: header.gid,\n    size: paxHeader.length,\n    mtime: header.mtime,\n    type: 'pax-header',\n    linkname: header.linkname && 'PaxHeader',\n    uname: header.uname,\n    gname: header.gname,\n    devmajor: header.devmajor,\n    devminor: header.devminor\n  }\n\n  this.push(headers.encode(newHeader))\n  this.push(paxHeader)\n  overflow(this, paxHeader.length)\n\n  newHeader.size = header.size\n  newHeader.type = header.type\n  this.push(headers.encode(newHeader))\n}\n\nPack.prototype._read = function (n) {\n  var drain = this._drain\n  this._drain = noop\n  drain()\n}\n\nmodule.exports = Pack\n"]}