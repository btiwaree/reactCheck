{"version":3,"sources":["extract.js"],"names":[],"mappings":"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","file":"extract-compiled.js","sourcesContent":["var util = require('util')\nvar bl = require('bl')\nvar xtend = require('xtend')\nvar headers = require('./headers')\n\nvar Writable = require('readable-stream').Writable\nvar PassThrough = require('readable-stream').PassThrough\n\nvar noop = function () {}\n\nvar overflow = function (size) {\n  size &= 511\n  return size && 512 - size\n}\n\nvar emptyStream = function (self, offset) {\n  var s = new Source(self, offset)\n  s.end()\n  return s\n}\n\nvar mixinPax = function (header, pax) {\n  if (pax.path) header.name = pax.path\n  if (pax.linkpath) header.linkname = pax.linkpath\n  header.pax = pax\n  return header\n}\n\nvar Source = function (self, offset) {\n  this._parent = self\n  this.offset = offset\n  PassThrough.call(this)\n}\n\nutil.inherits(Source, PassThrough)\n\nSource.prototype.destroy = function (err) {\n  this._parent.destroy(err)\n}\n\nvar Extract = function (opts) {\n  if (!(this instanceof Extract)) return new Extract(opts)\n  Writable.call(this, opts)\n\n  this._offset = 0\n  this._buffer = bl()\n  this._missing = 0\n  this._onparse = noop\n  this._header = null\n  this._stream = null\n  this._overflow = null\n  this._cb = null\n  this._locked = false\n  this._destroyed = false\n  this._pax = null\n  this._paxGlobal = null\n  this._gnuLongPath = null\n  this._gnuLongLinkPath = null\n\n  var self = this\n  var b = self._buffer\n\n  var oncontinue = function () {\n    self._continue()\n  }\n\n  var onunlock = function (err) {\n    self._locked = false\n    if (err) return self.destroy(err)\n    if (!self._stream) oncontinue()\n  }\n\n  var onstreamend = function () {\n    self._stream = null\n    var drain = overflow(self._header.size)\n    if (drain) self._parse(drain, ondrain)\n    else self._parse(512, onheader)\n    if (!self._locked) oncontinue()\n  }\n\n  var ondrain = function () {\n    self._buffer.consume(overflow(self._header.size))\n    self._parse(512, onheader)\n    oncontinue()\n  }\n\n  var onpaxglobalheader = function () {\n    var size = self._header.size\n    self._paxGlobal = headers.decodePax(b.slice(0, size))\n    b.consume(size)\n    onstreamend()\n  }\n\n  var onpaxheader = function () {\n    var size = self._header.size\n    self._pax = headers.decodePax(b.slice(0, size))\n    if (self._paxGlobal) self._pax = xtend(self._paxGlobal, self._pax)\n    b.consume(size)\n    onstreamend()\n  }\n\n  var ongnulongpath = function () {\n    var size = self._header.size\n    this._gnuLongPath = headers.decodeLongPath(b.slice(0, size))\n    b.consume(size)\n    onstreamend()\n  }\n\n  var ongnulonglinkpath = function () {\n    var size = self._header.size\n    this._gnuLongLinkPath = headers.decodeLongPath(b.slice(0, size))\n    b.consume(size)\n    onstreamend()\n  }\n\n  var onheader = function () {\n    var offset = self._offset\n    var header\n    try {\n      header = self._header = headers.decode(b.slice(0, 512))\n    } catch (err) {\n      self.emit('error', err)\n    }\n    b.consume(512)\n\n    if (!header) {\n      self._parse(512, onheader)\n      oncontinue()\n      return\n    }\n    if (header.type === 'gnu-long-path') {\n      self._parse(header.size, ongnulongpath)\n      oncontinue()\n      return\n    }\n    if (header.type === 'gnu-long-link-path') {\n      self._parse(header.size, ongnulonglinkpath)\n      oncontinue()\n      return\n    }\n    if (header.type === 'pax-global-header') {\n      self._parse(header.size, onpaxglobalheader)\n      oncontinue()\n      return\n    }\n    if (header.type === 'pax-header') {\n      self._parse(header.size, onpaxheader)\n      oncontinue()\n      return\n    }\n\n    if (self._gnuLongPath) {\n      header.name = self._gnuLongPath\n      self._gnuLongPath = null\n    }\n\n    if (self._gnuLongLinkPath) {\n      header.linkname = self._gnuLongLinkPath\n      self._gnuLongLinkPath = null\n    }\n\n    if (self._pax) {\n      self._header = header = mixinPax(header, self._pax)\n      self._pax = null\n    }\n\n    self._locked = true\n\n    if (!header.size) {\n      self._parse(512, onheader)\n      self.emit('entry', header, emptyStream(self, offset), onunlock)\n      return\n    }\n\n    self._stream = new Source(self, offset)\n\n    self.emit('entry', header, self._stream, onunlock)\n    self._parse(header.size, onstreamend)\n    oncontinue()\n  }\n\n  this._parse(512, onheader)\n}\n\nutil.inherits(Extract, Writable)\n\nExtract.prototype.destroy = function (err) {\n  if (this._destroyed) return\n  this._destroyed = true\n\n  if (err) this.emit('error', err)\n  this.emit('close')\n  if (this._stream) this._stream.emit('close')\n}\n\nExtract.prototype._parse = function (size, onparse) {\n  if (this._destroyed) return\n  this._offset += size\n  this._missing = size\n  this._onparse = onparse\n}\n\nExtract.prototype._continue = function () {\n  if (this._destroyed) return\n  var cb = this._cb\n  this._cb = noop\n  if (this._overflow) this._write(this._overflow, undefined, cb)\n  else cb()\n}\n\nExtract.prototype._write = function (data, enc, cb) {\n  if (this._destroyed) return\n\n  var s = this._stream\n  var b = this._buffer\n  var missing = this._missing\n\n  // we do not reach end-of-chunk now. just forward it\n\n  if (data.length < missing) {\n    this._missing -= data.length\n    this._overflow = null\n    if (s) return s.write(data, cb)\n    b.append(data)\n    return cb()\n  }\n\n  // end-of-chunk. the parser should call cb.\n\n  this._cb = cb\n  this._missing = 0\n\n  var overflow = null\n  if (data.length > missing) {\n    overflow = data.slice(missing)\n    data = data.slice(0, missing)\n  }\n\n  if (s) s.end(data)\n  else b.append(data)\n\n  this._overflow = overflow\n  this._onparse()\n}\n\nmodule.exports = Extract\n"]}